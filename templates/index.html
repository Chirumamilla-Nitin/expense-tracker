<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Expense Tracker</title>
<link rel="stylesheet" href="/static/style.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<h1>ðŸ’° Expense Tracker</h1>

<div class="form">
  <input type="text" id="category" placeholder="Category">
  <input type="number" id="amount" placeholder="Amount">
  <button onclick="addExpense()">Add Expense</button>
</div>

<div class="filter">
  <label>Filter by Category:</label>
  <select id="categoryFilter" onchange="loadExpenses()">
    <option>All</option>
    <option>Food</option>
    <option>Travel</option>
    <option>Others</option>
  </select>
</div>

<h3>All Expenses</h3>
<table id="expenseTable">
  <thead>
    <tr><th>Date</th><th>Category</th><th>Amount ($)</th><th>Actions</th></tr>
  </thead>
  <tbody></tbody>
</table>

<h3>Spending Breakdown</h3>
<canvas id="pieChart" width="300" height="300"></canvas>

<!-- Edit Modal -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <h3>Edit Expense</h3>
    <input type="text" id="editCategory" placeholder="Category">
    <input type="number" id="editAmount" placeholder="Amount">
    <button onclick="saveEdit()">Save</button>
  </div>
</div>

<script>
let editId = null;
let chart;

// Add Expense
async function addExpense() {
  const category = document.getElementById('category').value;
  const amount = document.getElementById('amount').value;
  if(!category||!amount){alert("Fill both fields!"); return;}
  await fetch('/add', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({category, amount})
  });
  document.getElementById('category').value='';
  document.getElementById('amount').value='';
  loadExpenses(); loadChart();
}

// Load Expenses
async function loadExpenses() {
  const filter = document.getElementById('categoryFilter').value;
  const res = await fetch('/expenses?category='+filter);
  const data = await res.json();
  const tbody = document.querySelector('#expenseTable tbody');
  tbody.innerHTML='';
  data.forEach(exp=>{
    tbody.innerHTML+=`<tr>
      <td>${exp.Date}</td>
      <td>${exp.Category}</td>
      <td>${exp.Amount}</td>
      <td>
        <button onclick="openEdit('${exp.ID}','${exp.Category}','${exp.Amount}')">Edit</button>
        <button onclick="deleteExpense('${exp.ID}')">Delete</button>
      </td>
    </tr>`;
  });
}

// Delete Expense
async function deleteExpense(id){
  await fetch('/delete/'+id,{method:'DELETE'});
  loadExpenses(); loadChart();
}

// Open Edit Modal
function openEdit(id,category,amount){
  editId=id;
  document.getElementById('editCategory').value=category;
  document.getElementById('editAmount').value=amount;
  document.getElementById('editModal').style.display='block';
}

function closeModal(){document.getElementById('editModal').style.display='none';}

// Save Edit
async function saveEdit(){
  const category=document.getElementById('editCategory').value;
  const amount=document.getElementById('editAmount').value;
  await fetch('/edit/'+editId,{
    method:'PUT',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({category,amount})
  });
  closeModal(); loadExpenses(); loadChart();
}

// Load Chart
async function loadChart(){
  const res = await fetch('/chart-data');
  const data = await res.json();
  const labels = Object.keys(data);
  const values = Object.values(data);
  const ctx = document.getElementById('pieChart').getContext('2d');
  if(chart) chart.destroy();
  if(labels.length===0){ctx.font="16px Arial"; ctx.fillText("No data yet!",50,100); return;}
  chart = new Chart(ctx,{type:'pie',data:{labels,datasets:[{data:values,backgroundColor:['#3498db','#2ecc71','#e74c3c','#f1c40f','#9b59b6']}]}})
}

window.onclick = function(event){
  if(event.target==document.getElementById('editModal')) closeModal();
}

loadExpenses(); loadChart();
</script>
</body>
</html>
